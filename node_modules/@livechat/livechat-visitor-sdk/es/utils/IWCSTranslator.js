var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _rateMap;

import identity from 'lodash/fp/identity';
import findKey from 'lodash/fp/findKey';
import * as rates from '../constants/rates';

var stripIncorrectCharacters = function stripIncorrectCharacters(text) {
	/**
  * Function removes those ASCII characters ranges:
  * 1-8, 11-12, 14-31, 127
  */
	return text.replace(/[\x01-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
};

var codeToBoolean = function codeToBoolean(code) {
	if (code === '1') {
		return true;
	}
	return false;
};

var rateMap = (_rateMap = {}, _rateMap[rates.NONE] = '0', _rateMap[rates.BAD] = '1', _rateMap[rates.GOOD] = '2', _rateMap);

var parseSubIWCS = function parseSubIWCS(subIWCS) {
	var params = subIWCS.split('&#45;');
	return {
		authorId: params[1],
		isTyping: codeToBoolean(params[2])
	};
};

// const rateToCode = (rate: $Values<typeof rates>) => rateMap[rate]
var rateToCode = function rateToCode(rate) {
	return rateMap[rate];
};

export var IWCSMessageNames = {
	NEW_AGENT: 'newAgent',
	NEW_AGENT_MESSAGE: 'newAgentMessage',
	CHAT_ENDED: 'chatEnded',
	VISITOR_QUEUED: 'visitorQueued',
	TYPING_INDICATOR: 'typingIndicator',
	RATE_CHAT: 'rateChat',
	FORWARD_CHAT_TRANSCRIPT: 'forwardChatTranscript'

	// const parseAgentIds = (agentsIds: string) => agentsIds.replace(/\;$/, '').split(';')

};var IWCSDictionary = {
	IWCS0002R: [IWCSMessageNames.NEW_AGENT, {
		'1': ['id'],
		'2': ['name'],
		// '4': ['chatId'], // WTF?!
		'12': ['chatId'], // old conference_id
		// '16': ['operators_id', parseAgentIds],
		'23': ['avatarUrl'],
		'25': ['jobTitle']
	}],
	IWCS0006R: [IWCSMessageNames.NEW_AGENT_MESSAGE, {
		'1': ['authorId'],
		'2': ['message'],
		'9': ['isMobile', codeToBoolean],
		'10': ['id']
	}],
	IWCS1007S: [IWCSMessageNames.CHAT_ENDED, null],
	IWCS1002S: [IWCSMessageNames.VISITOR_QUEUED, {
		'2': ['numberInQueue', parseInt],
		'3': ['waitingTime', parseInt]
	}],
	IWCS0002P: [IWCSMessageNames.TYPING_INDICATOR, {
		'2': ['realCommand', parseSubIWCS]
	}],
	IWCS0113C: [IWCSMessageNames.RATE_CHAT, {
		'1': ['visitorId'],
		'2': ['chatId'],
		'3': ['rate', rateToCode]
	}],
	IWCS0069C: [IWCSMessageNames.FORWARD_CHAT_TRANSCRIPT, {
		'1': ['visitorId'],
		'2': ['email'],
		'5': ['chatId']
	}]
};

export var translateIWCS = function translateIWCS(IWCSMessage) {
	var splittedMessage = IWCSMessage.split('^');
	var commandCode = splittedMessage[0],
	    data = splittedMessage.slice(1);

	var command = IWCSDictionary[commandCode];

	if (!command) {
		return null;
	}

	var commandName = command[0],
	    paramsMap = command[1];

	var parsedData = data.reduce(function (parsed, param, index) {
		if (!paramsMap || !paramsMap[index + 1]) {
			return parsed;
		}
		var _paramsMap = paramsMap[index + 1],
		    paramName = _paramsMap[0],
		    _paramsMap$ = _paramsMap[1],
		    parseFunction = _paramsMap$ === undefined ? identity : _paramsMap$;

		if (paramName === 'realCommand') {
			return _extends({}, parsed, parseFunction(param));
		}
		parsed[paramName] = parseFunction(param);
		return parsed;
	}, {});

	return {
		name: commandName,
		data: parsedData
	};
};

export var translateToIWCS = function translateToIWCS(methodName, data) {
	var IWCSCommandCode = findKey(function (iwcs) {
		return iwcs[0] === methodName;
	}, IWCSDictionary);
	var IWCSShapeDeclaration = IWCSDictionary[IWCSCommandCode][1];
	var maxParam = Math.max.apply(Math, Object.keys(IWCSShapeDeclaration));
	var translatedIWCS = [IWCSCommandCode];
	while (translatedIWCS.length < maxParam + 1) {
		var paramData = IWCSShapeDeclaration[translatedIWCS.length];
		if (!paramData) {
			translatedIWCS.push('');
			continue;
		}
		var paramName = paramData[0];
		var parsedData = stripIncorrectCharacters(data[paramName]).replace(/\^/g, '&#94;');
		if (paramData[1]) {
			translatedIWCS.push(paramData[1](parsedData));
			continue;
		}
		translatedIWCS.push(parsedData);
	}
	return translatedIWCS.join('^') + '^';
};